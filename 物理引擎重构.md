# 物理引擎重构文档：从 Cannon-es 迁移到 Rapier

本文档记录了将项目物理引擎从 `cannon-es` 迁移到 `@dimforge/rapier3d-compat` 的过程和原因。

## 1. 迁移原因

原有的 `cannon-es` 物理引擎在处理复杂的碰撞场景，特别是车辆与护栏、地形的精确交互时，遇到了性能和精度瓶颈。

*   **精度问题**: 使用简化的碰撞体（如 Box）无法准确模拟不规则物体的碰撞，导致穿模或不自然的碰撞反馈。
*   **性能限制**: `cannon-es` 是纯 JavaScript 实现，在高负载场景下性能可能不足。
*   **功能限制**: 缺乏内置的车辆物理支持，需要手动实现复杂的悬挂和轮胎模型。

为了提升游戏的物理真实感、性能和可扩展性，决定迁移到性能更优、功能更强大的 `Rapier` 物理引擎。

## 2. Rapier 引擎选择

选择 `@dimforge/rapier3d-compat` 的主要原因：

*   **高性能**: 使用 Rust 编写并通过 WebAssembly 编译，性能显著优于 JavaScript 引擎。
*   **精确碰撞**: 支持多种碰撞形状，包括凸包 (Convex Hull) 和三角网格 (Trimesh)，能更精确地模拟复杂模型。
*   **活跃开发**: Rapier 是一个活跃维护和持续更新的项目。
*   **特性丰富**: 提供包括 CCD（连续碰撞检测）、关节、传感器等高级物理特性。

## 3. 新的物理模块结构

为了适配 Rapier，对物理相关的代码结构进行了重构，主要集中在 `src/core/physics/rapier/` 目录下：

```
/src/core/physics/rapier/
├── shapes/
│   ├── RapierShapeFactory.js    # 统一的形状创建工厂 (已移除，功能合并)
│   ├── RapierRailShape.js       # 护栏专用形状生成器
│   └── RapierTerrainShape.js    # 地形形状生成器
├── RapierAdapter.js         # 适配器，提供兼容层，简化迁移
├── RapierRigidBodyFactory.js # 刚体和碰撞体工厂
└── RapierWorld.js           # Rapier 世界管理 (初始化, step, debug)
```

## 4. 主要模块职责

*   **`RapierWorld.js`**: 管理 Rapier 物理世界的生命周期（初始化、更新、事件处理、调试绘制）。
*   **`RapierAdapter.js`**: 提供一个兼容层，封装了 Rapier 的常用操作，使得在现有代码（如 `TrackManager.js`）中替换物理引擎更容易。
*   **`RapierRigidBodyFactory.js`**: 包含 `RapierRigidBodyFactory` 和 `RapierColliderFactory` 两个类，分别用于创建不同类型的 Rapier 刚体描述符和碰撞体描述符。
*   **`shapes/RapierRailShape.js`**: 专门负责根据场景中的护栏模型创建精确的 Rapier 碰撞体（优先使用凸包，特殊情况处理偏移）。
*   **`shapes/RapierTerrainShape.js`**: 专门负责根据场景中的地形模型创建 Rapier 碰撞体（支持高度图和三角网格）。

## 5. 车辆物理重构

由于 Rapier 没有内置的 `RaycastVehicle`，车辆物理系统也进行了重构：

*   **`src/game/rapier/vehicle/VehiclePhysics_Rapier.js`**: 实现了基于 Rapier 的车辆物理逻辑。使用射线检测模拟悬挂，手动计算和施加悬挂力、转向力、驱动/刹车力。
*   **`src/game/rapier/vehicle/VehicleController_Rapier.vue`**: 新的车辆控制器 Vue 组件，负责实例化 `VehiclePhysicsRapier`，处理用户输入，并同步 3D 模型与物理状态。

## 6. 调试工具

*   **`src/game/rapier/vehicle/VehicleDebugUI.vue`**: 新增的 Vue 组件，用于在运行时实时显示和调整车辆的关键物理参数（如悬挂刚度、摩擦力、引擎力等），极大地方便了手感调优。

## 7. 集成与测试

*   **`src/views/Race.vue`**: 作为主要的比赛场景视图，集成了新的 Rapier 物理系统、车辆控制器和调试 UI。
*   移除了旧的 `PhysicsEngine.vue` 组件。
*   使用 `useRapierPhysics.js` composable 来管理物理世界的初始化和更新。
*   调整了组件的加载和初始化顺序，确保物理世界在需要时已准备就绪。

通过这次重构，项目的物理系统获得了显著的性能提升和更高的真实感，为后续实现更复杂的赛车行为（如漂移、跳跃）打下了坚实的基础。 