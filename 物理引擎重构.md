# 物理引擎重构文档：从 Cannon-es 迁移到 Rapier

本文档记录了将项目物理引擎从 `cannon-es` 迁移到 `@dimforge/rapier3d-compat` 的过程和原因。

## 1. 迁移原因

原有的 `cannon-es` 物理引擎在处理复杂的碰撞场景，特别是车辆与护栏、地形的精确交互时，遇到了性能和精度瓶颈。

*   **精度问题**: 使用简化的碰撞体（如 Box）无法准确模拟不规则物体的碰撞，导致穿模或不自然的碰撞反馈。
*   **性能限制**: `cannon-es` 是纯 JavaScript 实现，在高负载场景下性能可能不足。
*   **功能限制**: 缺乏内置的车辆物理支持，需要手动实现复杂的悬挂和轮胎模型。

为了提升游戏的物理真实感、性能和可扩展性，决定迁移到性能更优、功能更强大的 `Rapier` 物理引擎。

## 2. Rapier 引擎选择

选择 `@dimforge/rapier3d-compat` 的主要原因：

*   **高性能**: 使用 Rust 编写并通过 WebAssembly 编译，性能显著优于 JavaScript 引擎。
*   **精确碰撞**: 支持多种碰撞形状，包括凸包 (Convex Hull) 和三角网格 (Trimesh)，能更精确地模拟复杂模型。
*   **活跃开发**: Rapier 是一个活跃维护和持续更新的项目。
*   **特性丰富**: 提供包括 CCD（连续碰撞检测）、关节、传感器等高级物理特性。

## 3. 新的物理模块结构

为了适配 Rapier，对物理相关的代码结构进行了重构，主要集中在 `src/core/physics/rapier/` 目录下：

```
/src/core/physics/rapier/
├── shapes/
│   ├── RapierShapeFactory.js    # 统一的形状创建工厂 (已移除，功能合并)
│   ├── RapierRailShape.js       # 护栏专用形状生成器
│   └── RapierTerrainShape.js    # 地形形状生成器
├── RapierAdapter.js         # 适配器，提供兼容层，简化迁移
├── RapierRigidBodyFactory.js # 刚体和碰撞体工厂
└── RapierWorld.js           # Rapier 世界管理 (初始化, step, debug)
```

## 4. 主要模块职责

*   **`RapierWorld.js`**: 管理 Rapier 物理世界的生命周期（初始化、更新、事件处理、调试绘制）。
*   **`RapierAdapter.js`**: 提供一个兼容层，封装了 Rapier 的常用操作，使得在现有代码（如 `TrackManager.js`）中替换物理引擎更容易。
*   **`RapierRigidBodyFactory.js`**: 包含 `RapierRigidBodyFactory` 和 `RapierColliderFactory` 两个类，分别用于创建不同类型的 Rapier 刚体描述符和碰撞体描述符。
*   **`shapes/RapierRailShape.js`**: 专门负责根据场景中的护栏模型创建精确的 Rapier 碰撞体（优先使用凸包，特殊情况处理偏移）。
*   **`shapes/RapierTerrainShape.js`**: 专门负责根据场景中的地形模型创建 Rapier 碰撞体（支持高度图和三角网格）。

## 5. 车辆物理重构

由于 Rapier 没有内置的 `RaycastVehicle`，车辆物理系统也进行了重构：

*   **`src/game/rapier/vehicle/VehiclePhysics_Rapier.js`**: 实现了基于 Rapier 的车辆物理逻辑。使用射线检测模拟悬挂，手动计算和施加悬挂力、转向力、驱动/刹车力。
*   **`src/game/rapier/vehicle/VehicleController_Rapier.vue`**: 新的车辆控制器 Vue 组件，负责实例化 `VehiclePhysicsRapier`，处理用户输入，并同步 3D 模型与物理状态。

## 6. 调试工具

*   **`src/game/rapier/vehicle/VehicleDebugUI.vue`**: 新增的 Vue 组件，用于在运行时实时显示和调整车辆的关键物理参数（如悬挂刚度、摩擦力、引擎力等），极大地方便了手感调优。

## 7. 集成与测试

*   **`src/views/Race.vue`**: 作为主要的比赛场景视图，集成了新的 Rapier 物理系统、车辆控制器和调试 UI。
*   移除了旧的 `PhysicsEngine.vue` 组件。
*   使用 `useRapierPhysics.js` composable 来管理物理世界的初始化和更新。
*   调整了组件的加载和初始化顺序，确保物理世界在需要时已准备就绪。

## 8. 下一步：高级碰撞检测系统规划

基于 Rapier 引擎的优势，计划实现一个更加精确、高效和丰富的碰撞检测系统：

### 8.1 碰撞检测系统架构

新的碰撞检测系统将采用分层设计：

```
/src/core/collision/rapier/
├── RapierCollisionManager.js        # 碰撞事件管理器
├── RapierCollisionFilters.js        # 碰撞过滤器（分组和掩码）
├── RapierCollisionSensors.js        # 碰撞传感器（区域触发）
├── feedback/
│   ├── RapierCollisionFeedback.js   # 视觉和听觉反馈
│   ├── RapierDeformableBody.js      # 可变形碰撞体（车辆变形）
│   └── RapierParticleSystem.js      # 碰撞粒子效果
└── utils/
    ├── RapierContactMaterials.js    # 材质属性定义
    ├── RapierCollisionVisualizer.js # 调试可视化
    └── RapierBroadphaseOptimizer.js # 宽相碰撞优化
```

### 8.2 碰撞检测功能规划

#### 8.2.1 精确碰撞检测

* **复合碰撞体**：为复杂对象（如车辆）创建由多个基本碰撞体组成的复合碰撞体，提高碰撞精度。
* **动态细节级别**：根据与玩家的距离动态调整碰撞体的细节级别。
* **连续碰撞检测**：利用 Rapier 的 CCD 功能，防止高速物体穿过薄物体。

#### 8.2.2 高效碰撞过滤

* **碰撞分组**：实现灵活的碰撞组和掩码系统，控制哪些对象可以相互碰撞。
* **空间分区优化**：使用四叉树/八叉树优化宽相阶段的碰撞检测。
* **休眠管理**：合理设置静止物体的休眠阈值，减少计算量。

#### 8.2.3 丰富的碰撞反馈

* **材质系统**：为不同表面定义不同的物理属性（如摩擦、反弹）。
* **车身变形**：轻度碰撞导致临时变形，重度碰撞导致永久变形。
* **视觉效果**：根据碰撞力度、角度和材质生成适当的火花、碎片、烟雾等效果。
* **音效系统**：基于材质类型、速度和冲击力动态混合碰撞音效。
* **震动反馈**：支持手柄震动，增强沉浸感。

### 8.3 关键组件实现计划

#### 8.3.1 RapierCollisionManager

* 统一管理碰撞事件的注册、分发和处理。
* 提供事件订阅接口，让不同系统（如UI、音效）可以响应碰撞。
* 实现碰撞冷却机制，防止短时间内重复触发同一碰撞事件。

#### 8.3.2 RapierCollisionFeedback

* 根据碰撞数据（力度、角度、材质）决定反馈类型。
* 管理视觉效果（粒子系统、临时变形）的生命周期。
* 与音效系统集成，播放适当的碰撞音效。

#### 8.3.3 RapierDeformableBody

* 为车辆实现可变形碰撞体，碰撞后会临时或永久变形。
* 根据碰撞强度和方向改变车辆外观。
* 变形还会对车辆性能产生影响（如严重变形会降低最高速度）。

### 8.4 实现路线图

1. **阶段一：基础碰撞系统**
   - 实现 RapierCollisionManager 的核心功能
   - 建立碰撞分组和过滤系统
   - 为赛道和障碍物创建优化的碰撞体

2. **阶段二：碰撞反馈增强**
   - 实现基本的视觉反馈（火花、碎片）
   - 添加基础碰撞音效系统
   - 开发碰撞调试可视化工具

3. **阶段三：高级特性**
   - 车辆变形系统
   - 碰撞环境破坏（如护栏变形、路标倒塌）
   - 性能优化（空间分区、碰撞预测）

4. **阶段四：完善与调优**
   - 根据用户反馈优化碰撞手感
   - 完善各类材质的反馈效果
   - 优化系统性能和内存占用

### 8.5 预期效果

新的碰撞检测系统将显著提升游戏体验：

* **更真实的物理反馈**：车辆碰撞赛道或其他障碍物时表现更真实
* **丰富的视听效果**：不同材质的碰撞产生不同的视觉和听觉反馈
* **更稳定的性能**：即使在复杂场景下也能保持流畅帧率
* **更好的游戏手感**：碰撞反馈使驾驶体验更加直观和沉浸

通过这次重构，项目的物理系统获得了显著的性能提升和更高的真实感，为后续实现更复杂的赛车行为（如漂移、跳跃）和碰撞反馈系统打下了坚实的基础。 